

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Custom C++ Bindings &mdash; Pyroborobo 0.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Troubleshooting" href="troubleshooting.html" />
    <link rel="prev" title="Object Creation" href="objects.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Pyroborobo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">How to use pyroborobo</a></li>
<li class="toctree-l1"><a class="reference internal" href="objects.html">Object Creation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Custom C++ Bindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">API documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/agent_observer.html">AgentObserver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/controller.html">Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/pyroborobo.html">Pyroborobo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/squareobject.html">Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/world_model.html">World Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/worldobserver.html">WorldObserver</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Pyroborobo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Custom C++ Bindings</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tuto/write_custom_cpp_bindings.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="custom-c-bindings">
<h1>Custom C++ Bindings<a class="headerlink" href="#custom-c-bindings" title="Permalink to this headline">¶</a></h1>
<p>You can add custom C++ bindings to your pyroborobo installation. To do
so, you must declare your C++ classes in the pybind11 pyroborobo module.</p>
<p>You should definitely read the <a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">pybind11 tutorial and
documentation</a> before
trying to write your own bindings.</p>
<p>Looking at the source of the module definitions in
<code class="docutils literal notranslate"><span class="pre">contrib/pyroborobo/moduledefinitions</span></code> give you nice examples of how
to write custom c++ to python bindings.</p>
<p>As an example, let’ pretend that we want to create a new controller
subclass <code class="docutils literal notranslate"><span class="pre">DistAwareController</span></code> that adds the method
<code class="docutils literal notranslate"><span class="pre">distance_to_robot(int</span> <span class="pre">id)</span></code> in pyroborobo. The function
<code class="docutils literal notranslate"><span class="pre">distanceToRobot</span></code> is written in C++.</p>
<p>Let’s create a new project in roborobo. To do so, let’s clone the
roborobo’s <code class="docutils literal notranslate"><span class="pre">Tutorial</span></code> project.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s assume you are in the roborobo directory</span>
<span class="nb">cd</span> prj
python2 clone_project.py Tutorial DistAware
</pre></div>
</div>
<p>There is now a folder <code class="docutils literal notranslate"><span class="pre">DistAware</span></code> in our <code class="docutils literal notranslate"><span class="pre">prj</span></code> folder. Let’s add the
method <code class="docutils literal notranslate"><span class="pre">DistanceToRobot(int</span> <span class="pre">id)</span></code> that compute the Euclidian distance
between the robot and the other robot of id <code class="docutils literal notranslate"><span class="pre">id</span></code>. Let’s add its
signature in <code class="docutils literal notranslate"><span class="pre">prj/DistAware/include/DistAwareController.h</span></code></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DistAwareController</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Controller</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">DistAwareController</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">RobotWorldModel</span><span class="o">&gt;</span> <span class="n">_wm</span><span class="p">);</span>

    <span class="o">~</span><span class="n">DistAwareController</span><span class="p">();</span>

    <span class="kt">void</span> <span class="nf">reset</span><span class="p">();</span>

    <span class="kt">void</span> <span class="nf">step</span><span class="p">();</span>

    <span class="kt">float</span> <span class="nf">distanceToRobot</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p>And let’s define this method in
<code class="docutils literal notranslate"><span class="pre">prj/DistAware/src/DistAwareController.cpp</span></code></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span> <span class="n">DistAwareController</span><span class="o">::</span><span class="n">distanceToRobot</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">other</span> <span class="o">=</span> <span class="n">gWorld</span><span class="o">-&gt;</span><span class="n">getRobot</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getController</span><span class="p">();</span> <span class="c1">// return shared_ptr&lt;Controller&gt;</span>
    <span class="k">auto</span> <span class="n">opos</span> <span class="o">=</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">getPosition</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">getPosition</span><span class="p">();</span>
    <span class="kt">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">opos</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">pos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pow</span><span class="p">(</span><span class="n">opos</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">pos</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">dist</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now that we have created our new controller, let’s create its python
bindings.</p>
<p>Create a new file called <code class="docutils literal notranslate"><span class="pre">DistAwarePythonBindings.cpp</span></code> in
<code class="docutils literal notranslate"><span class="pre">prj/DistAware/src/pyroborobo</span></code> and a file called <code class="docutils literal notranslate"><span class="pre">DistAwarePythonBindings.h</span></code> in
<code class="docutils literal notranslate"><span class="pre">prj/DistAware/include/pyroborobo</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Your pyroborobo specific code <strong>must be</strong> in a pyroborobo folder. Being in a folder named pyroborobo <strong>prevents</strong> your code from being included in the standalone version of <code class="docutils literal notranslate"><span class="pre">roborobo</span></code>. Having pyroborobo specific cod in a file which is not in a folder named <code class="docutils literal notranslate"><span class="pre">pyroborobo</span></code> will prevent your code from compiling.</p>
</div>
<p>We will write the special python bindings in these files. To add a new
python binding in pyroborobo, we must create a function that receives as
an argument a reference to a <code class="docutils literal notranslate"><span class="pre">pybind11::module</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// DistAwarePythonBindings.h</span>
<span class="cp">#ifndef ROBOROBO3_DISTAWAREPYTHONBINDINGS_H</span>
<span class="cp">#define ROBOROBO3_DISTAWAREPYTHONBINDINGS_H</span>

<span class="cp">#include</span> <span class="cpf">&lt;pybind11/pybind11.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">addDistAwareBindings</span><span class="p">(</span><span class="n">pybind11</span><span class="o">::</span><span class="k">module</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

<span class="cp">#endif </span><span class="c1">//ROBOROBO3_DISTAWAREPYTHONBINDINGS_H</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// DistAwarePythonBindings.cpp</span>
<span class="cp">#include</span> <span class="cpf">&quot;DistAware/include/DistAwarePythonBindings.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;DistAware/include/DistAwareController.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;WorldModels/RobotWorldModel.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pybind11/pybind11.h&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">py</span> <span class="o">=</span> <span class="n">pybind11</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">pybind11</span><span class="o">::</span><span class="n">literals</span><span class="p">;</span>  <span class="c1">// allow string literals like &quot;argument&quot;_a</span>

<span class="kt">void</span> <span class="nf">addDistAwareBindings</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="k">module</span><span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Now, we have to tell pybind11 that we want to add new bindings for our controller. Let’s write <code class="docutils literal notranslate"><span class="pre">addDistAwareBindings</span></code>.</p>
<p>First we must declare our new class, using <code class="docutils literal notranslate"><span class="pre">pybind11::class_</span></code>. In code, the <code class="xref any docutils literal notranslate"><span class="pre">pybind11</span></code> namespace is shorten with <code class="docutils literal notranslate"><span class="pre">py</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">addDistAwareBindings</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="k">module</span><span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">distcont</span> <span class="o">=</span> <span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">DistAwareController</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">DistAwareController</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DistAwareController&quot;</span><span class="p">,</span> <span class="sa">R</span><span class="s">&quot;</span><span class="dl">doc(</span><span class="s">Our custom DistAwareController</span><span class="dl">)doc</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The usage of <code class="docutils literal notranslate"><span class="pre">pybind11::class_</span></code> is complex. You should definitely look at its documentation. To be short, the first argument of the template is the class that we want to bind, the second argument is the class from which our class inherits. It allows <code class="xref any docutils literal notranslate"><span class="pre">pybind11</span></code> to know that we want to access all the methods written in Controller. The third argument is the way we want pybind11 to handle reference counts. Here we use the cpp shared pointer, used everywhere in roborobo. It prevents segfault when the python interpreter stops. The first argument of the constructor is our module <code class="docutils literal notranslate"><span class="pre">m</span></code> that we received in argument. It is the <code class="docutils literal notranslate"><span class="pre">pyroborobo</span></code> module where we want to attach our class. The second argument is the name of the python Class for <code class="docutils literal notranslate"><span class="pre">pyroborobo</span></code>. The third argument is the docstring of our class.</p>
<p>We <strong>must</strong> declare a python constructor for our new class. To add a new method to our class, we use the <code class="docutils literal notranslate"><span class="pre">def</span></code> method.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">addDistAwareBindings</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="k">module</span><span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">distcont</span> <span class="o">=</span> <span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">DistAwareController</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">RobotWorldModel</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DistAwareController&quot;</span><span class="p">);</span>
    <span class="n">distcont</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">init</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">RobotWorldModel</span><span class="o">&gt;&gt;</span><span class="p">(),</span> <span class="s">&quot;robot_world_model&quot;</span><span class="n">_a</span><span class="p">,</span> <span class="sa">R</span><span class="s">&quot;</span><span class="dl">doc(</span><span class="s">our custom Controller Init function</span><span class="dl">)doc</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We add the special method <code class="docutils literal notranslate"><span class="pre">__init__</span></code> with <code class="docutils literal notranslate"><span class="pre">py::init</span></code>. The init template takes as argument the type of the constructor arguments, here a shared pointer to a <code class="docutils literal notranslate"><span class="pre">RobotWorldModel</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Not using <code class="docutils literal notranslate"><span class="pre">std::shared_pointer</span></code> here will cause segfaults!!!</p>
</div>
<p>Finally, we add the binding to our function with another call to <code class="docutils literal notranslate"><span class="pre">def</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">addDistAwareBindings</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="k">module</span><span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">distcont</span> <span class="o">=</span> <span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">DistAwareController</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">DistAwareController</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DistAwareController&quot;</span><span class="p">);</span>
    <span class="n">distcont</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">init</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">RobotWorldModel</span><span class="o">&gt;&gt;</span><span class="p">(),</span> <span class="s">&quot;world_model&quot;</span><span class="n">_a</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">distcont</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;get_distance_to_robot&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DistAwareController</span><span class="o">::</span><span class="n">distanceToRobot</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="n">_a</span><span class="p">,</span> <span class="sa">R</span><span class="s">&quot;</span><span class="dl">doc(</span><span class="s">float: The distance to the robot of id ``id``.</span><span class="dl">)doc</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We call def on our python class definition and give it its python name, the pointer to the method we want to call, and we provide the name of the arguments as well as a docstring.</p>
<p>Now, we just have to add our python bindings function to the module. To do so, we must edit the file <code class="docutils literal notranslate"><span class="pre">src/contrib/pyroborobo/customModuleDefinitions.cpp</span></code> and add a call to our function in <code class="docutils literal notranslate"><span class="pre">addCustomBindings</span></code> and an include of our header file.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;pybind11/pybind11.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;contrib/pyroborobo/customModuleDefinitions.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;DistAware/include/pyroborobo/DistAwarePythonBindings.h&quot;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">dummyCustomBindings</span><span class="p">(</span><span class="n">pybind11</span><span class="o">::</span><span class="k">module</span><span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">addCustomBindings</span><span class="p">(</span><span class="n">pybind11</span><span class="o">::</span><span class="k">module</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* append your custom bindings in this function</span>
<span class="cm">     * dummyCustomBindings is given as an exemple</span>
<span class="cm">     */</span>
    <span class="n">dummyCustomBindings</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
    <span class="n">addDistAwareBindings</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Let’s now compile pyroborobo by running</p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span> <span class="pre">--force</span>
<span class="pre">`</span></code></p>
<p>The class DistAwareController is now available in pyroborobo.</p>
<p>It is only a very simple introduction to adding bindings for pyroborobo. Writing bindings can get complex really quickly. Please read carefully the pybind11 documentation as well as the already implemented bindings. They are all in <code class="docutils literal notranslate"><span class="pre">src/contrib/pyroborobo/moduledefinitions/</span></code>.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="troubleshooting.html" class="btn btn-neutral float-right" title="Troubleshooting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="objects.html" class="btn btn-neutral float-left" title="Object Creation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Paul Ecoffet, Nicolas Bredeche

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>